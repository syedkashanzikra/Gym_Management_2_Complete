import{_ as $,r as c,o as a,a as d,w as i,f as o,M as S,N as V,e as r,aF as Q,J as U,h as k,t as g,a4 as N,a8 as T,g as C,u as x,L as z,d as v,n as A,F as q,ag as B,K as O,I,Q as R}from"./index.46fdd451.js";import{Q as F}from"./QItemLabel.249954d1.js";import{u as P,P as E}from"./stripe.esm.e1002465.js";import{Q as D}from"./QSkeleton.a3e15f44.js";import{B as J}from"./BaseSectionSkeleton.fd87b72d.js";import{A as K,S as j}from"./AddPaymentMethod.07f1e0b4.js";const G={components:{BaseSectionSkeleton:J},props:{loading:{type:Boolean,default:!0}},computed:{animation(){return this.loading?"wave":"none"}}};function W(e,n,l,m,s,t){const h=c("base-section-skeleton");return a(),d(h,{loading:l.loading,flat:"",bordered:""},{default:i(()=>[o(D,{animation:t.animation,width:"50%",type:"text"},null,8,["animation"]),o(D,{animation:t.animation,width:"55%",type:"text"},null,8,["animation"]),o(D,{animation:t.animation,width:"50%",type:"text"},null,8,["animation"])]),_:1},8,["loading"])}var X=$(G,[["render",W]]);const H={id:"manual",icon:"fas fa-money-check-dollar",card_number:"cash",exp_date:"payCash",card:{}},Y={props:{modelValue:{}},emits:["update:model-value"],data(){return{offlinePayment:H,loading:!0}},methods:{...S(P,["getPaymentMethods","addPaymentMethod"]),onAddPaymentMethod(){console.func("components/payment-methods/PaymentMethods:methods.onAddPaymentMethod()",arguments),this.$q.dialog({component:K}).onOk(({payment_method:e,isDefault:n,card:l,hide:m})=>{const{last4:s}=l;this.addPaymentMethod({payment_method:e,last_four_digit:s,is_default:n}).then(({message:t})=>{m(),this.$core.success(t,{title:this.$t("dialog.title.success")})}).catch(t=>{this.$core.error(t,{title:this.$t("dialog.title.error")})})})}},async mounted(){var e;await this.getPaymentMethods(),(e=this.defaultPaymentMethod)!=null&&e.id||this.$emit("update:model-value",H),this.loading=!1},computed:{...V(P,["paymentMethods","defaultPaymentMethod"])}};function Z(e,n,l,m,s,t){const h=c("base-select");return a(),d(h,{dense:"",outlined:"",options:[...e.paymentMethods,s.offlinePayment],"option-label":p=>e.$t(p==null?void 0:p.card_number),"model-value":l.modelValue,"onUpdate:modelValue":n[0]||(n[0]=p=>e.$emit("update:model-value",p))},null,8,["options","option-label","model-value"])}var ee=$(Y,[["render",Z]]);const te={components:{PlanCard:E,SelectPaymentMethods:ee,StripeCard:j},name:"ChangePlan",props:{title:String},emits:["ok","hide"],data(){return{plan:null,interval:"month",paymentMethod:null,loading:!1,loaded:!1}},methods:{...S(P,["subscribe","confirm"]),show(){var e;console.func("components/subscription/ChangePlan:methods.show()",arguments),(e=this.defaultPaymentMethod)!=null&&e.id&&(this.paymentMethod={...this.defaultPaymentMethod}),this.$refs.dialog.show(),setTimeout(()=>{this.loaded=!0},100)},hide(){console.func("components/subscription/ChangePlan:methods.close()",arguments),this.$refs.dialog.hide()},onDialogHide(){console.func("components/subscription/ChangePlan:methods.onDialogHide()",arguments),this.paymentMethod=null,this.loaded=!1,this.$emit("hide")},onDone(){console.func("components/subscription/ChangePlan:methods.onDone()",arguments),this.$emit("ok"),this.hide()},onSuccess({id:e,card:n}){console.func("components/ManageSubscription:methods.onSuccess()",arguments),this.loading=!0;const{last4:l}=n;this.subscribe({plan:this.plan.id,payment_interval:this.interval,payment_method:e,last_four_digit:l}).then(m=>{this.loading=!0;const{message:s,requiresAction:t,paymentIntent:h}=m;t?this.$refs.stripeCard.confirmPaymentMethod(h):(this.loading=!1,this.onDone(),this.$core.success(s,{title:this.$t("dialog.title.success")}))}).catch(m=>{this.loading=!1,this.$core.error(m,{title:this.$t("dialog.title.error")})})},onFailed(e){console.func("components/ManageSubscription:methods.onFailed()",arguments),this.$core.error(e,{title:this.$t("dialog.title.paymentFailed")}),this.loading=!1},onConfirmed(e){console.func("components/ManageSubscription:methods.onConfirmed()",arguments),this.confirm({plan:this.plan.id,payment_intent:e.id}).then(({message:n})=>{this.$core.success(n,{title:this.$t("dialog.title.success")}),this.loading=!1,this.onDone()}).catch(n=>{this.loading=!1,this.$core.error(n,{title:this.$t("dialog.title.paymentAuthenticationFailure")})})}},computed:{...V(P,["plans","currentPlan","defaultPlan","selectedPlan","defaultPaymentMethod","billingDetails"]),price(){var e;return(e=this.plan)==null?void 0:e.prices.find(({interval:n})=>n===this.interval)}},mounted(){this.$nextTick(()=>{var e,n,l;this.plan=this.selectedPlan(((e=this.currentPlan)==null?void 0:e.plan.id)||((n=this.defaultPlan)==null?void 0:n.plan.id)),this.interval=((l=this.currentPlan)==null?void 0:l.interval)||"month"})}},ne={class:"q-px-sm"},se={class:"q-gutter-y-md"},ae={class:""};function oe(e,n,l,m,s,t){const h=c("base-select"),p=c("plan-card"),_=c("base-label"),w=c("select-payment-methods"),M=c("stripe-card"),u=c("base-dialog");return a(),d(u,{title:l.title,ref:"dialog","content-style":"width: 450px; max-width: 95vw","body-class":"scroll",class:"change-plan",onHide:t.onDialogHide,onOk:n[3]||(n[3]=y=>t.onSuccess(s.paymentMethod)),"use-separator":"",loading:s.loading,"done-label":e.$t("proceed")},{body:i(()=>{var y;return[r("div",ne,[r("div",se,[o(h,{dense:"",outlined:"",options:e.plans,"option-label":"label",modelValue:s.plan,"onUpdate:modelValue":n[0]||(n[0]=f=>s.plan=f)},null,8,["options","modelValue"]),o(p,Q({flat:"","no-radio":""},s.plan,{"is-custom":s.plan.is_custom,interval:s.interval}),null,16,["is-custom","interval"]),o(U,{modelValue:s.interval,"onUpdate:modelValue":n[1]||(n[1]=f=>s.interval=f),"true-value":"year","false-value":"month",color:"green",label:e.$t("yearly"),dense:""},null,8,["modelValue","label"]),r("div",ae,[o(_,null,{default:i(()=>[k(g(e.$t("paymentMethod")),1)]),_:1}),o(w,{modelValue:s.paymentMethod,"onUpdate:modelValue":n[2]||(n[2]=f=>s.paymentMethod=f)},null,8,["modelValue"]),s.loaded?N((a(),d(M,{key:0,amount:(y=t.price)==null?void 0:y.amount,processing:s.loading,onSuccess:t.onSuccess,onConfirmed:t.onConfirmed,onFailed:t.onFailed,billingDetails:e.billingDetails,ref:"stripeCard"},null,8,["amount","processing","onSuccess","onConfirmed","onFailed","billingDetails"])),[[T,!1]]):C("",!0)])])])]}),_:1},8,["title","onHide","loading","done-label"])}var le=$(te,[["render",oe]]);const ie={components:{CurrentPlanSkeleton:X},props:{noUpgrade:Boolean,noAction:Boolean,userId:[String,Number]},emits:["changed"],data(){return{cancelLoading:!1,resumeLoading:!1}},methods:{...S(x,["currentUser"]),...S(P,["cancel","cancelDowngrade","resume","getSubscribed","setUser"]),onCancelDowngrade(){this.cancelLoading=!0,this.cancelDowngrade().then(({message:e})=>{this.cancelLoading=!1,this.$core.success(e,{title:this.$t("dialog.title.success")})}).catch(e=>{this.cancelLoading=!1,this.$core.error(e)})},onCancelPlan(){this.$core.confirm(this.$t("dialog.info.cancel"),{title:this.$t("dialog.title.cancel")}).then(()=>{this.cancelLoading=!0,console.func("components/subscription/CurrentPlanCard:methods.onCancelPlan()",arguments),this.cancel().then(({message:e})=>{this.cancelLoading=!1,this.$core.success(e,{title:this.$t("dialog.title.success")})}).catch(e=>{this.cancelLoading=!1,this.$core.error(e)})})},onResumePlan(){this.$core.confirm("Are you sure you want to resume?").then(()=>{this.resumeLoading=!0,console.func("components/subscription/CurrentPlanCard:methods.onResumePlan()",arguments),this.resume().then(({message:e})=>{this.resumeLoading=!1,this.$core.success(e,{title:this.$t("dialog.title.success")})}).catch(e=>{this.resumeLoading=!1,this.$core.error(e)})})},onChangePlan(){this.$q.dialog({component:le,componentProps:{title:this.subscribeLabel}}).onOk(async()=>{this.$emit("changed"),await this.getSubscribed()})}},computed:{...V(P,["subscription","currentPlan","upcomingInvoice","isLoadingSubscription","defaultPlan","hasCancelled","isSubscribed","usages"]),price(){return this.currentPlan||this.defaultPlan},interval(){var e;return this.$core.capitalize(((e=this.price)==null?void 0:e.interval)||"month")+"ly"},intervalLabel(){return this.$core.priceToInterval(this.price)},subscribeLabel(){return this.isSubscribed||this.hasCancelled?this.$t("upgradePlan"):this.$t("subscribeNow")},isActive(){return this.subscription.is_valid},isDowngrade(){return this.subscription.is_downgrade},planBadge(){var e;return((e=this.subscription)==null?void 0:e.stripe_status)||this.interval},features(){return this.usages.map(e=>({...e,key:this.$core.toCamelCase(e.label)}))}},async mounted(){this.userId&&(await this.setUser(this.userId),await this.getSubscribed())}},re={class:"renewal-fee"},ce={class:"amount text-subtitle2"},de={class:"q-ml-xs interval"},ue={class:"text-h6"},me={key:0},he=["innerHTML"],pe={key:1,class:"q-py-sm usages"},ge={class:"label text-h6"},fe={key:2,class:"features"},be=["innerHTML"],_e={class:"text-right"};function ye(e,n,l,m,s,t){const h=c("base-status"),p=c("base-tooltip"),_=c("base-btn"),w=c("current-plan-skeleton"),M=c("base-section");return a(),d(M,{flat:"",bordered:"",class:"currnet-plan-card",dense:"","no-row":""},z({action:i(()=>{var u;return[r("div",re,[r("span",ce,g(e.$core.money((u=t.price)==null?void 0:u.amount)),1),r("span",de,g(t.intervalLabel),1)])]}),title:i(()=>{var u;return[r("div",ue,[k(g((u=t.price)==null?void 0:u.plan.label)+" ",1),o(h,{type:t.planBadge},null,8,["type"])])]}),default:i(()=>{var u,y,f;return[(u=e.subscription)!=null&&u.message?(a(),v("div",me,[r("span",{style:{"font-size":"13px"},class:A({"text-negative":!e.isSubscribed}),innerHTML:e.subscription.message},null,10,he)])):C("",!0),e.isSubscribed?(a(),v("div",pe,[r("div",ge,g(e.$t("features"))+":",1),(a(!0),v(q,null,B(t.features,(b,L)=>(a(),d(O,{dense:"",key:L,class:"feature text-grey-10 q-pa-none"},{default:i(()=>[o(I,null,{default:i(()=>[o(F,null,{default:i(()=>[k(g(e.$t("plan.features."+b.key))+" ",1),o(R,{size:"12px",name:"fal fa-info-circle"},{default:i(()=>[o(p,null,{default:i(()=>[k(g(e.$t("hint.features."+b.key)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(I,{side:""},{default:i(()=>[o(F,null,{default:i(()=>[r("span",{class:A({"text-bold":!0,"text-negative":b.value===b.usage})},g(b.usage),3),r("span",null,"/"+g(b.value),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))])):(f=(y=t.price)==null?void 0:y.plan)!=null&&f.feature_lines?(a(),v("div",fe,[r("ul",null,[(a(!0),v(q,null,B(t.price.plan.feature_lines,(b,L)=>(a(),v("li",{key:L},[r("span",{innerHTML:b},null,8,be)]))),128))])])):C("",!0)]}),_:2},[l.noAction?void 0:{name:"bottom",fn:i(()=>[r("div",_e,[e.hasCancelled?(a(),d(_,{key:0,onClick:t.onResumePlan,loading:s.resumeLoading,label:e.$t("resumeNow"),color:"warning",class:"q-mr-sm",link:""},null,8,["onClick","loading","label"])):t.isDowngrade?(a(),d(_,{key:1,onClick:t.onCancelDowngrade,loading:s.cancelLoading,label:e.$t("cancelDowngrade"),color:"warning",class:"q-mr-sm",link:""},null,8,["onClick","loading","label"])):t.isActive?(a(),d(_,{key:2,onClick:t.onCancelPlan,loading:s.cancelLoading,color:"negative",label:e.$t("cancelPlan"),class:"q-mr-sm",link:""},null,8,["onClick","loading","label"])):C("",!0),l.noUpgrade?e.hasCancelled?C("",!0):(a(),d(_,{key:4,onClick:t.onChangePlan,color:"primary",label:t.subscribeLabel,link:""},null,8,["onClick","label"])):(a(),d(_,{key:3,to:{name:"Subscription"},color:"primary",label:t.subscribeLabel,link:""},null,8,["label"]))])]),key:"0"},e.isLoadingSubscription?{name:"skeleton",fn:i(()=>[o(w)]),key:"1"}:void 0]),1024)}var we=$(ie,[["render",ye]]);export{X as C,we as a};
