import{M as H,N as M,aE as w,_ as Q,r as g,o as r,a as h,w as l,f as a,ac as I,e as p,a9 as B,ab as N,d as m,F as y,ag as x,h as k,t as f,J as D,a4 as T,a8 as O,aD as U,l as S,g as _,af as R,a7 as E,Q as F,L as j,k as V,n as J,K,I as L,ah as G,ai as W}from"./index.46fdd451.js";import{Q as X}from"./QBadge.942c3fbf.js";import{Q as b}from"./QTd.d26cec80.js";import{c as A,Q as Y}from"./QTable.1702d6ef.js";import{Q as Z}from"./QSelect.37e8c679.js";import{Q as q}from"./QTr.6cbeded8.js";import{Q as $}from"./QInnerLoading.1459e1ed.js";import{u as z}from"./index.dbe12f27.js";import{C as ee,A as te}from"./CustomProduct.000af489.js";const oe={data(){return{selected:this.modelValue,products:[],current_page:1,last_page:1,loading:!1,filter:this.query,sortBy:"TITLE_ASC",product_columns:[{name:"thumbnail",label:"Product",field:"thumbnail",align:"left",sortable:!1},{name:"source_stock",label:"Total Available",field:e=>e.has_variant?"":this.getStocks(e,this.source),align:"right",sortable:!1,style:"width: 150px; white-space: normal"}]}},props:{modelValue:{required:!1,type:[Array],default:()=>[]},source:{required:!1,type:[Object,Boolean],default:!1},columns:{required:!1,type:[Array],default:()=>[]},hint:[String],query:[String],title:{type:[String],default:"Select products"},loadFromServer:{type:[Boolean],required:!1,default:!0}},emits:["ok","hide"],methods:{...H(z,["get"]),onLoadProduct(e){var t;console.func("components/product/InventorySelector:methods.onLoadProduct()",arguments),this.loading=!0,this.current_page=e.page,this.get({...e,filter:this.filter,sortBy:this.sortBy,rowsPerPage:10,location:(t=this.source)==null?void 0:t.id,includes:["variants","default_variant"]}).then(({data:n,meta:c})=>{this.products=n,this.current_page=c.current_page,this.last_page=c.last_page,this.loading=!1}).catch(()=>{this.loading=!1})},async show(){console.func("components/product/InventorySelector:methods.show()",arguments),this.loadFromServer&&await this.onLoadProduct({page:this.current_page}),this.columns.forEach(e=>{this.product_columns.push(e)}),this.$refs.dialog.show()},hide(){console.func("components/product/InventorySelector:methods.close()",arguments),this.$refs.dialog.hide()},onDialogHide(){console.func("components/product/InventorySelector:methods.onDialogHide()",arguments),this.$emit("hide")},onDone(){console.func("components/product/InventorySelector:methods.onDone()",arguments),this.$emit("ok",this.selected),this.hide()},onSelected(e){if(console.func("components/product/InventorySelector:methods.onSelected()",arguments),e.has_variant){const t=this.selected.filter(c=>c.product_id===e.id).length,n=e.variants.length;e.variants.forEach(c=>{this.onVariantSelected(c,e,t===n)})}else this.onVariantSelected(e.default_variant,e)},onVariantSelected(e,t,n=!0){console.func("components/product/InventorySelector:methods.onVariantSelected()",arguments),this.selectedVariants.filter(o=>o===e.id).length?n&&(this.selected=this.selected.filter(o=>o.variant_id!==e.id)):this.selected.push({product_id:e.product_id,product:t,title:t.title,variant_id:e.id,taxable:e.taxable,variant:e,variant_title:e.title,price:e.price,thumbnail:e.thumbnail,sku:e.sku,quantity:1})},onBrowseProduct(e,t){console.func("components/product/InventorySelector:methods.onBrowseProduct()",arguments),this[t]=e,this.onLoadProduct({page:1})},getStocks(e,t){if(!e.default_variant.inventories.length)return"-";const n=e.default_variant.inventories.filter(o=>t&&o.location_id===t.id&&o.active||!t&&o.active).map(o=>parseInt(o.available));if(!n.length)return"-";const c=n.reduce((o,d)=>o+d);return c<=0?`<span class="no-inventory">${c}</span>`:c},getVariantStocks(e,t){if(!e.inventories.length)return"-";const n=e.inventories.filter(o=>t&&o.location_id===t.id&&o.active||!t&&o.active).map(o=>parseInt(o.available));if(!n.length)return"-";const c=n.reduce((o,d)=>o+d);return c<=0?`<span class="no-inventory">${c}</span>`:c}},computed:{...M(z,["sortOptions"]),disable(){return this.selected===this.modelValue},visibleColumns(){return this.product_columns.map(e=>e.name)},selectedVariants(){return w.exports.uniq(this.selected.filter(e=>e.variant_id).map(e=>e.variant_id))},selectedProducts(){return w.exports.uniq(this.selected.filter(e=>e.product_id).map(e=>e.product_id))}}},ne={class:"col"},le={class:"col-auto"},ae={style:{width:"280px"},class:"flex items-center"},se={style:{width:"200px","white-space":"normal"},class:"q-ml-md"},re=["innerHTML"],ie=["innerHTML"],de=["innerHTML"],ce=["innerHTML"],ue={class:"q-gutter-sm"};function me(e,t,n,c,o,d){const v=g("base-thumbnail"),P=g("base-dialog");return r(),h(P,{title:n.title,"body-class":"q-pa-none","body-style":"",ref:"dialog",persistent:"",onHide:d.onDialogHide,"use-separator":""},{body:l(()=>[a(I,{class:"q-col-gutter-md row"},{default:l(()=>[p("div",ne,[a(B,{dense:"",outlined:"",type:"text",modelValue:o.filter,"onUpdate:modelValue":[t[0]||(t[0]=i=>o.filter=i),t[1]||(t[1]=i=>d.onBrowseProduct(i,"filter"))],clearable:"",debounce:"500",placeholder:"Search products"},null,8,["modelValue"])]),p("div",le,[a(Z,{style:{width:"200px"},prefix:"Sort: ","map-options":"","options-dense":"","emit-value":"",modelValue:o.sortBy,"onUpdate:modelValue":[t[2]||(t[2]=i=>o.sortBy=i),t[3]||(t[3]=i=>d.onBrowseProduct(i,"sortBy"))],options:e.sortOptions,dense:"",outlined:""},null,8,["modelValue","options"])])]),_:1}),a(N),a(A,{flat:"",square:"",style:{"max-height":"50vh","min-height":"50vh"},rows:o.products,columns:o.product_columns,"row-key":"id","hide-bottom":"",class:"sticky-header","visible-columns":d.visibleColumns},{header:l(i=>[a(q,{props:i},{default:l(()=>[(r(!0),m(y,null,x(i.cols,u=>(r(),h(Y,{key:u.name,props:i},{default:l(()=>[k(f(u.label),1)]),_:2},1032,["props"]))),128))]),_:2},1032,["props"])]),body:l(i=>[a(q,{onClick:u=>d.onSelected(i.row),class:"cursor-pointer",props:i},{default:l(()=>[(r(!0),m(y,null,x(i.cols,u=>(r(),h(b,{key:u.name,props:i},{default:l(()=>[u.name==="thumbnail"?(r(),h(D,{key:0,size:"sm",dense:"","model-value":d.selectedProducts,"onUpdate:modelValue":s=>d.onSelected(i.row),val:i.row.id},{default:l(()=>[p("div",ae,[p("div",null,[a(v,{size:40,media:i.row.thumbnail},null,8,["media"])]),p("div",se,f(i.row.title),1)])]),_:2},1032,["model-value","onUpdate:modelValue","val"])):u.name==="source_stock"?(r(),m("span",{key:1,innerHTML:u.value},null,8,re)):(r(),m("span",{key:2,innerHTML:u.value},null,8,ie))]),_:2},1032,["props"]))),128))]),_:2},1032,["onClick","props"]),(r(!0),m(y,null,x(i.row.variants,(u,s)=>T((r(),h(q,{key:s,props:i,class:"cursor-pointer",onClick:C=>d.onVariantSelected(u,i.row)},{default:l(()=>[a(b,{colspan:"1",style:{width:"50px"}},{default:l(()=>[a(D,{class:"q-ml-xl",size:"sm",dense:"","model-value":d.selectedVariants,"onUpdate:modelValue":C=>d.onVariantSelected(u,i.row),val:u.id},{default:l(()=>[p("div",null,f(u.title),1)]),_:2},1032,["model-value","onUpdate:modelValue","val"])]),_:2},1024),a(b,{colspan:"1",class:"text-right"},{default:l(()=>[p("span",{innerHTML:d.getVariantStocks(u,n.source)},null,8,de)]),_:2},1024),a(b,{colspan:"1",class:"text-right"},{default:l(()=>[p("span",{innerHTML:u.price_formated},null,8,ce)]),_:2},1024)]),_:2},1032,["props","onClick"])),[[O,i.row.has_variant]])),128))]),_:1},8,["rows","columns","visible-columns"]),a($,{showing:o.loading},{default:l(()=>[a(U,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),footer:l(()=>[a(I,{class:"flex"},{default:l(()=>[n.loadFromServer?(r(),m(y,{key:0},[a(S,{disable:o.current_page<=1||o.loading,onClick:t[4]||(t[4]=i=>d.onLoadProduct({page:o.current_page-1>=1?o.current_page-1:1})),dense:"",round:"",flat:"",color:"primary",icon:"fal fa-angle-left"},null,8,["disable"]),a(S,{disable:o.current_page==o.last_page||o.loading,onClick:t[5]||(t[5]=i=>d.onLoadProduct({page:o.current_page+1<=o.last_page?o.current_page+1:1})),dense:"",round:"",flat:"",color:"primary",icon:"fal fa-angle-right"},null,8,["disable"])],64)):_("",!0),a(R),p("div",ue,[T(a(S,{"no-caps":"",outline:"",label:e.$t("label.cancel"),color:"grey"},null,8,["label"]),[[E]]),a(S,{disable:d.disable,"no-caps":"",label:e.$t("label.done"),color:"primary",onClick:d.onDone},null,8,["disable","label","onClick"])])]),_:1})]),_:1},8,["title","onHide"])}var he=Q(oe,[["render",me]]);const fe={props:{title:[String],product_id:[String,Number],variant_id:[String,Number],is_product_deleted:{type:[Boolean],default:!1,required:!1},is_variant_deleted:{type:[Boolean],default:!1,required:!1},is_custom:{type:[Boolean],default:!1,required:!1},attributes:{}}},pe={key:2};function _e(e,t,n,c,o,d){const v=g("base-btn"),P=g("base-tooltip");return r(),m("div",null,[n.is_custom?(r(),m(y,{key:0},[k(f(n.title),1)],64)):(r(),m(y,{key:1},[!n.is_product_deleted&&!n.is_variant_deleted?(r(),h(v,{key:0,link:"",size:"12px",tag:"a",to:{name:"products.variant",params:{product_id:n.product_id,variant_id:n.variant_id},query:{action:"edit"}}},{default:l(()=>[k(f(n.title),1)]),_:1},8,["to"])):n.is_product_deleted?(r(),m("span",pe,[k(f(n.title)+" ",1),n.is_product_deleted?(r(),h(F,{key:0,class:"q-ml-xs",name:"fad fa-info-circle",size:"13px",color:"negative"},{default:l(()=>[a(P,null,{default:l(()=>[k("This product has been deleted.")]),_:1})]),_:1})):_("",!0)])):(r(),h(v,{key:1,link:"",size:"12px",tag:"a",to:{name:"Single Product",params:{id:n.product_id},query:{action:"edit"}}},{default:l(()=>[k(f(n.title),1)]),_:1},8,["to"]))],64))])}var ve=Q(fe,[["render",_e]]);const ge={components:{ProductTitle:ve},props:{modelValue:{type:[Array],required:!0},view:Boolean,canNotRemove:Boolean},emits:["update:model-value"],data(){return{products:w.exports.cloneDeep(this.modelValue),columns:[{name:"product",align:"left",label:"Product",field:"title",sortable:!1,view:!0},{name:"price",align:"right",label:"Price",style:"width: 150px;",field:"discounted_price",format:e=>this.$core.money(e),sortable:!1,view:!0},{name:"quantity",align:"left",label:"Quantity",style:"width: 150px;",field:"quantity",sortable:!1,view:!1},{name:"total",align:this.view?"right":"left",label:"Total",style:"width: 90px;",field:"total",format:e=>this.$core.money(e),sortable:!1,view:!0},{name:"action",align:"right",label:"",style:"width: 10px; padding-left: 0",field:"action",sortable:!1,view:!1}]}},methods:{onBrowseProduct(e){console.func("components/order/ProductsCard:methods.onBrowseProduct()",arguments),this.$q.dialog({component:he,componentProps:{query:e,columns:[{name:"price",label:"Price",field:t=>t.has_variant?"":t.price,align:"right",sortable:!1,style:"width: 150px; white-space: normal"}],modelValue:w.exports.cloneDeep(this.products)}}).onOk(t=>{console.func("components/order/ProductsCard:methods.onBrowseProduct.onOk()",t),this.products=w.exports.cloneDeep(t),this.$emit("update:model-value",this.products)})},onRemoveItem({rowIndex:e}){console.func("components/order/ProductsCard:methods.onRemoveItem()",arguments),this.products.splice(e,1),this.$emit("update:model-value",this.products)},onAddCustomProduct(){console.func("components/order/ProductsCard:methods.onAddCustomProduct()",arguments),this.$q.dialog({component:ee}).onOk(e=>{console.func("components/order/ProductsCard:methods.onAddCustomProduct.onOk()",e),this.products.push(e),this.$emit("update:model-value",this.products)})},onChangeQuantity(){console.func("components/order/ProductsCard:methods.onChangeQuantity()",arguments),this.$core.debounce(()=>{this.$emit("update:model-value",this.products)},500)},addDiscount(e){console.func("components/order/ProductsCard:methods.addDiscount()",arguments),this.$q.dialog({component:te,componentProps:{modelValue:w.exports.cloneDeep(e.discount),update:Boolean(e.discount)}}).onOk(t=>{console.func("components/order/ProductsCard:methods.addDiscount.onOk()",t),t||(e.discount_removed=!0),e.discount=t,this.$emit("update:model-value",this.products)})}},watch:{modelValue:{deep:!0,handler(e){this.products=w.exports.cloneDeep(e)}}},computed:{visibleColumns(){return this.columns.filter(e=>this.view&&e.view||!this.view).filter(e=>this.canNotRemove&&e.name!=="action"||!this.canNotRemove).map(e=>e.name)}}},ye={key:0,class:"q-mb-md row"},be={class:"col"},we={key:1},ke={key:0},Se={key:1},Pe={key:0,class:"q-ml-sm text-strike text-grey"},Ce={key:2};function xe(e,t,n,c,o,d){const v=g("base-btn"),P=g("base-thumbnail"),i=g("product-title"),u=g("base-section");return r(),h(u,{title:"Products","no-row":""},j({action:l(()=>[n.view?_("",!0):(r(),h(v,{key:0,link:"",size:"14px",padding:"0",label:"Add custom product",onClick:d.onAddCustomProduct},null,8,["onClick"])),V(e.$slots,"action")]),default:l(()=>[n.view?_("",!0):(r(),m("div",ye,[p("div",be,[a(B,{dense:"",outlined:"",type:"text",placeholder:"Search products",debounce:"500","onUpdate:modelValue":d.onBrowseProduct},{after:l(()=>[a(S,{onClick:t[0]||(t[0]=s=>d.onBrowseProduct("")),"no-caps":"",outline:"",padding:"8px",style:{width:"100px"},color:"primary",label:"Browse"})]),_:1},8,["onUpdate:modelValue"])])])),V(e.$slots,"top"),o.products.length?(r(),m("div",we,[a(A,{ref:"product",class:J({"main-table":!n.view,"no-hover":n.view}),square:"",flat:"",dense:n.view,"hide-header":n.view,rows:o.products,columns:o.columns,"hide-pagination":"","rows-per-page-options":[0],"visible-columns":d.visibleColumns,separator:n.view?"none":"horizontal"},{"body-cell-product":l(s=>[a(b,{props:s},{default:l(()=>[a(K,{class:"q-pa-none",dense:""},{default:l(()=>[a(L,{avatar:""},{default:l(()=>[a(P,{size:40,media:s.row.thumbnail},{default:l(()=>[n.view?(r(),h(X,{key:0,rounded:"",floating:"",color:"orange-3","text-color":"black",label:s.row.remaining_quantity||s.row.quantity},null,8,["label"])):_("",!0)]),_:2},1032,["media"])]),_:2},1024),a(L,{avatar:""},{default:l(()=>[a(i,G(W(s.row)),null,16),s.row.variant_title?(r(),m("div",ke,f(s.row.variant_title),1)):_("",!0),s.row.reason?(r(),m("div",Se," Reason: "+f(s.row.reason),1)):_("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-quantity":l(s=>[a(b,{props:s},{default:l(()=>[a(B,{dense:"",outlined:"",modelValue:s.row.quantity,"onUpdate:modelValue":[C=>s.row.quantity=C,d.onChangeQuantity],modelModifiers:{number:!0},"input-style":"text-align: center",type:"number",min:"1"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-price":l(s=>[a(b,{props:s},{default:l(()=>[n.view?(r(),m(y,{key:0},[s.row.has_discount?(r(),h(v,{key:0,link:"",class:"text-strike",label:s.row.price},null,8,["label"])):_("",!0),k(" "+f(s.value)+" x "+f(s.row.remaining_quantity||s.row.quantity),1)],64)):(r(),m(y,{key:1},[a(v,{link:"",color:"primary",size:"0.72rem",onClick:C=>d.addDiscount(s.row),label:s.value},null,8,["onClick","label"]),s.row.has_discount?(r(),m("span",Pe,f(e.$core.money(s.row.price)),1)):_("",!0)],64))]),_:2},1032,["props"])]),"body-cell-action":l(s=>[a(b,{props:s},{default:l(()=>[a(S,{round:"",dense:"",flat:"",size:"sm",color:"primary",icon:"fal fa-times",onClick:C=>d.onRemoveItem(s)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["class","dense","hide-header","rows","columns","visible-columns","separator"])])):(r(),m("div",Ce))]),_:2},[e.$slots.bottom?{name:"bottom",fn:l(()=>[V(e.$slots,"bottom")]),key:"0"}:void 0]),1024)}var Ae=Q(ge,[["render",xe]]);export{Ae as P};
